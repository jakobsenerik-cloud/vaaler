<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <title>Turkart ‚Äì produksjon (imageOverlay)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .panel {
      position: fixed; z-index: 1000; left: 10px; top: 10px;
      background: rgba(255,255,255,.94); padding: 10px 12px; border-radius: 10px;
      font: 14px/1.35 system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,.08); width: 320px;
    }
    .row { margin-top: 8px; }
    .btn { cursor:pointer; padding:6px 10px; border-radius:8px; border:1px solid #ddd; background:#f6f6f6 }
    .btn:active { transform: translateY(1px) }
    .range { width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <label class="row"><input type="checkbox" id="toggleOsm"> Vis OSM bakgrunn</label>
    <div class="row">Gjennomsiktighet PNG:
      <input id="opacity" type="range" min="0" max="100" value="85" class="range">
      <span id="opVal">85%</span>
    </div>
    <div class="row">
      <button id="centerBtn" class="btn">üìç Sentrer p√• meg</button>
    </div>
  </div>

  <script>
    const west  = 10.7587;
    const east  = 11.1997;
    const north = 59.5483;
    const south = 59.3800;

    const imageUrl = './Turkart.png';
    const imageBounds = [[south, west], [north, east]]; // [SW, NE]

    const map = L.map('map').fitBounds(imageBounds);
    const overlay = L.imageOverlay(imageUrl, imageBounds).addTo(map);

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap-bidragsytere' });
    const toggle = document.getElementById('toggleOsm');
    if (new URLSearchParams(location.search).get('osm') === '1') { toggle.checked = true; osm.addTo(map); }
    toggle.addEventListener('change', () => toggle.checked ? osm.addTo(map) : map.removeLayer(osm));

    map.setMaxBounds(imageBounds);
    map.setMinZoom(map.getZoom() - 1);
    map.setMaxZoom(22);

    const opacityRange = document.getElementById('opacity');
    const opVal = document.getElementById('opVal');
    function setOpacity() {
      const v = parseInt(opacityRange.value, 10) / 100;
      opVal.textContent = Math.round(v * 100) + '%';
      overlay.setOpacity(v);
    }
    setOpacity();
    opacityRange.addEventListener('input', setOpacity);

    let gpsMarker=null, accuracyCircle=null;
    map.on('locationfound', (e) => {
      if (!gpsMarker) gpsMarker = L.marker(e.latlng).addTo(map);
      else gpsMarker.setLatLng(e.latlng);
      if (!accuracyCircle) accuracyCircle = L.circle(e.latlng, { radius:e.accuracy, color:'blue', fillOpacity:.2 }).addTo(map);
      else accuracyCircle.setLatLng(e.latlng).setRadius(e.accuracy);
    });
    map.on('locationerror', (err) => console.warn('GPS-feil:', err && err.message));
    map.locate({ setView:false, watch:true, enableHighAccuracy:true, maxZoom:20 });

    document.getElementById('centerBtn').addEventListener('click', () => {
      if (gpsMarker) map.setView(gpsMarker.getLatLng(), Math.max(map.getZoom(), 18));
      else map.locate({ setView:true, maxZoom:18 });
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js?version=16').then(() => {
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
        }
      });
    }
  </script>
</body>
</html>
